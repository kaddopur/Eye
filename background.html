<html>
<head>
  <!-- ver 1.5 -->
  <script>
    function render(tab) {
      if (correctDomain(tab.url) &&
          keepGoing(tab.url)) {
        chrome.tabs.update(tab.id, {'url': 'result.html?url=' + tab.url});
      }
    }
    
    function correctDomain(targetUrl) {
      var flagBasic = false;
      var flagDomain = false;
      
      if(targetUrl != '' &&
         targetUrl.search('result.html') == -1){
        flagBasic = true;
      }
      
      var domainList = ["http://1mh.com/",
                        "http://99mh.com/",
                        "http://dm.99manga.com/",
                        "http://mh.99770.cc/",
                        "http://www.99comic.com/",
                        "http://www.cococomic.com/",
                        "http://www.99mh.com/",
                        "http://www.99manga.com/"];
                        
      for(var i=0; i<domainList.length; i++){
        flagDomain = flagDomain || targetUrl.search(domainList[i]) != -1;
      }
      
      return flagBasic && flagDomain;
    }
    
    function keepGoing(targetUrl) {
      var req;
      req = new XMLHttpRequest();
      req.open("GET", targetUrl, false);
      req.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
              
      var encoded = "";
      req.send(encoded);
              
      var response = req.responseText;
      
      return response.search('PicListUrl') != -1;
    }

    chrome.tabs.onSelectionChanged.addListener(function(tabId) {
      //chrome.tabs.get(tabId, showIcon);
    });
    
    //chrome.tabs.getSelected(null, showIcon);
    
    chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
      render(tab);
    });
    
  </script>
</head>

<body>
<canvas id="canvas" width="19" height="19"></canvas>
</body>
</html>
