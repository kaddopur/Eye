<html>
<head>
  <!-- ver 1.6.1 -->
  <script src="js/jquery-1.7.1.min.js"></script>
  <script src="js/jquery-ui-1.8.17.custom.min.js"></script>
  <script src="js/jquery.cookie.js"></script>
  
  <script>
    function render(tab) {
      $.get(tab.url, function(data){
        if(data.search('PicListUrl') != -1 &&
           correctDomain(tab.url)){
          chrome.tabs.update(tab.id, {'url': 'result.html?url=' + tab.url});
        }
      });
      
      if(correctDomain(tab.url)){
        checkNewest();
      }
    }
    
    function correctDomain(targetUrl) {
      var flagBasic = false;
      var flagDomain = false;
      
      if(targetUrl != '' &&
         targetUrl.search('result.html') == -1){
        flagBasic = true;
      }
      
      var domainList = ["http://1mh.com/",
                        "http://99mh.com/",
                        "http://dm.99manga.com/",
                        "http://mh.99770.cc/",
                        "http://www.99comic.com/",
                        "http://www.cococomic.com/",
                        "http://www.99mh.com/",
                        "http://www.99manga.com/"];
                        
      for(var i=0; i<domainList.length; i++){
        flagDomain = flagDomain || targetUrl.search(domainList[i]) != -1;
      }
      
      return flagBasic && flagDomain;
    }

    chrome.tabs.onSelectionChanged.addListener(function(tabId) {
      //chrome.tabs.get(tabId, showIcon);
    });
    
    //chrome.tabs.getSelected(null, showIcon);
    
    chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
      render(tab);
      
    });
    
    function checkNewest(){
      $.get("http://mh.99770.cc/comicupdate/", function(data){
        rx = /href="(.*)" target="_blank" class="lkgn">(.*)<\/a><font color=red><b>(.*)<\/b><\/font>(.*)<span/g;
        m = rx.exec(data);
        newestLine = m[2]+' '+m[3]+' '+m[4];
        lineList = data.match(rx);
        
        if(newestLine != localStorage.getItem("newest")){
          for(var i=0; i<lineList.length; i++){
            rx = /href="(.*)" target="_blank" class="lkgn">(.*)<\/a><font color=red><b>(.*)<\/b><\/font>(.*)<span/;
            m = rx.exec(lineList[i]);
            thisLine = m[2]+' '+m[3]+' '+m[4];
            var targetPage = m[2];
            
            // it's cool below
            if(thisLine == localStorage.getItem("newest")){ break; }
            
            // continue if it's not in subscription
            if(!in_array(targetPage, JSON.parse(localStorage.subs))){ continue; } 
            
            var notification = window.webkitNotifications.createNotification(
              'icon48.png',          // The image.
              thisLine,              // The title.
              '已更新，點擊觀看'     // The body.
            );
            
            // create direct URL
            $.get("http://mh.99770.cc" + targetPage, function(data){
              var rx = /<li><a href=(.*) target/;
              var directURL = "http://mh.99770.cc" + rx.exec(data)[1];
              
              notification.onclick = function(){
                //console.log(directURL);
                chrome.tabs.create({
                  'url': directURL
                });
                this.cancel();
              };
              notification.show();
            });
          } 
          localStorage.setItem("newest", newestLine);
        } else {
          //console.log(localStorage.getItem("newest") + new Date());
        }
      });
    }
    
    if (window.webkitNotifications) {
      var interval = 0; // The display interval, in minutes.

      setInterval(function() {
        checkNewest();
        interval = 0;
      }, 300000);
    }
    
    function in_array(stringToSearch, arrayToSearch) {
      for (s = 0; s < arrayToSearch.length; s++) {
        thisEntry = arrayToSearch[s].toString();
        if (thisEntry == stringToSearch) {
          return true;
        }
      }
      return false;
    }
    
  </script>
</head>

<body>
<canvas id="canvas" width="19" height="19"></canvas>
</body>
</html>
