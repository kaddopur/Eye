// Generated by CoffeeScript 1.4.0
var bind, bindListener, fetch, loadEpisode, refreshBadge, userList;

userList = localStorage.userList != null ? JSON.parse(localStorage.userList) : [];

localStorage.userList = JSON.stringify(userList);

refreshBadge = function() {
  var badgeText, ele, newCount, unreadList;
  newCount = ((function() {
    var _i, _len, _results;
    _results = [];
    for (_i = 0, _len = userList.length; _i < _len; _i++) {
      ele = userList[_i];
      if (ele.isNew) {
        _results.push(ele);
      }
    }
    return _results;
  })()).length;
  badgeText = newCount !== 0 ? '' + newCount : '';
  chrome.browserAction.setBadgeText({
    text: badgeText
  });
  unreadList = ((function() {
    var _i, _len, _results;
    _results = [];
    for (_i = 0, _len = userList.length; _i < _len; _i++) {
      ele = userList[_i];
      if (ele.isNew) {
        _results.push(ele);
      }
    }
    return _results;
  })()) || [];
  return loadEpisode();
};

loadEpisode = function() {
  var ele, i, priorityList, user8comicList, userDm5List, userSfacgList, _i, _j, _k, _len, _len1, _len2, _results;
  priorityList = (function() {
    var _i, _len, _results;
    _results = [];
    for (_i = 0, _len = userList.length; _i < _len; _i++) {
      ele = userList[_i];
      if (ele.isNew) {
        _results.push(ele);
      }
    }
    return _results;
  })();
  priorityList = priorityList.concat((function() {
    var _i, _len, _results;
    _results = [];
    for (_i = 0, _len = userList.length; _i < _len; _i++) {
      ele = userList[_i];
      if (ele.episodeUrl !== ele.edgeUrl && !ele.isNew) {
        _results.push(ele);
      }
    }
    return _results;
  })());
  priorityList = priorityList.concat((function() {
    var _i, _len, _results;
    _results = [];
    for (_i = 0, _len = userList.length; _i < _len; _i++) {
      ele = userList[_i];
      if (ele.episodeUrl === ele.edgeUrl && !ele.isNew) {
        _results.push(ele);
      }
    }
    return _results;
  })());
  userDm5List = ((function() {
    var _i, _len, _results;
    _results = [];
    for (_i = 0, _len = priorityList.length; _i < _len; _i++) {
      ele = priorityList[_i];
      if (ele.site === 'dm5') {
        _results.push(ele);
      }
    }
    return _results;
  })()) || [];
  user8comicList = ((function() {
    var _i, _len, _results;
    _results = [];
    for (_i = 0, _len = priorityList.length; _i < _len; _i++) {
      ele = priorityList[_i];
      if (ele.site === '8comic') {
        _results.push(ele);
      }
    }
    return _results;
  })()) || [];
  userSfacgList = ((function() {
    var _i, _len, _results;
    _results = [];
    for (_i = 0, _len = priorityList.length; _i < _len; _i++) {
      ele = priorityList[_i];
      if (ele.site === 'sfacg') {
        _results.push(ele);
      }
    }
    return _results;
  })()) || [];
  if (user8comicList != null) {
    for (i = _i = 0, _len = user8comicList.length; _i < _len; i = ++_i) {
      ele = user8comicList[i];
      $('#eightComic ul').append("        <li id='eightComic-" + i + "'>          <div class='new'>NEW</div>          <div class='read'>READ</div>          <div class='cover'>            <img src='" + ele.pic + "'>          </div>          <div class='info'>            <div class='title'>" + ele.title + "</div>            <div class='episode'>看到 " + ele.episodeNumber + "</div>            <div class='edge'>更新到 " + ele.edgeNumber + "</div>          </div>          <input type='button' value='續看'>        </li>");
      if (!ele.isNew) {
        $("#eightComic-" + i + " .new").css('display', 'none');
      }
      if (!(ele.episodeUrl !== ele.edgeUrl && !ele.isNew)) {
        $("#eightComic-" + i + " .read").css('display', 'none');
      }
      bind("#eightComic-" + i, ele);
    }
  }
  if (userDm5List != null) {
    for (i = _j = 0, _len1 = userDm5List.length; _j < _len1; i = ++_j) {
      ele = userDm5List[i];
      $('#dm5 ul').append("        <li id='dm5-" + i + "'>          <div class='new'>NEW</div>          <div class='read'>READ</div>          <div class='cover'>            <img src='" + ele.pic + "'>          </div>          <div class='info'>            <div class='title'>" + ele.title + "</div>            <div class='episode'>看到 " + ele.episodeNumber + "</div>            <div class='edge'>更新到 " + ele.edgeNumber + "</div>          </div>          <input type='button' value='續看'>        </li>");
      if (!ele.isNew) {
        $("#dm5-" + i + " .new").css('display', 'none');
      }
      if (!(ele.episodeUrl !== ele.edgeUrl && !ele.isNew)) {
        $("#dm5-" + i + " .read").css('display', 'none');
      }
      bind("#dm5-" + i, ele);
    }
  }
  if (userSfacgList != null) {
    _results = [];
    for (i = _k = 0, _len2 = userSfacgList.length; _k < _len2; i = ++_k) {
      ele = userSfacgList[i];
      $('#sfacg ul').append("        <li id='sfacg-" + i + "'>          <div class='new'>NEW</div>          <div class='read'>READ</div>          <div class='cover'>            <img src='" + ele.pic + "'>          </div>          <div class='info'>            <div class='title'>" + ele.title + "</div>            <div class='episode'>看到 " + ele.episodeNumber + "</div>            <div class='edge'>更新到 " + ele.edgeNumber + "</div>          </div>          <input type='button' value='續看'>        </li>");
      if (!ele.isNew) {
        $("#sfacg-" + i + " .new").css('display', 'none');
      }
      if (!(ele.episodeUrl !== ele.edgeUrl && !ele.isNew)) {
        $("#sfacg-" + i + " .read").css('display', 'none');
      }
      _results.push(bind("#sfacg-" + i, ele));
    }
    return _results;
  }
};

bind = function(target, params) {
  return $("" + target + " input").click(function() {
    return chrome.tabs.create({
      url: params.episodeUrl
    });
  });
};

bindListener = function() {
  var lastTab;
  $('#eightComic header').click(function() {
    return chrome.tabs.create({
      url: 'http://www.8comic.com/comic/'
    });
  });
  $('#dm5 header').click(function() {
    return chrome.tabs.create({
      url: 'http://tel.dm5.com/'
    });
  });
  $('#sfacg header').click(function() {
    return chrome.tabs.create({
      url: 'http://comic.sfacg.com/'
    });
  });
  $('nav li').click(function() {
    $('nav li.active').removeClass('active');
    $(this).addClass('active');
    $('.tab.tab-show').removeClass('tab-show');
    $($(this).data('tab')).addClass('tab-show');
    return localStorage.lastTab = $(this).data('no');
  });
  lastTab = localStorage.lastTab != null ? localStorage.lastTab : '1';
  return $("nav li:nth-child(" + lastTab + ")").click();
};

fetch = function() {
  var bundle;
  if (localStorage.isSync === 'true') {
    bundle = {
      account: localStorage.account,
      password: localStorage.password,
      userlist: localStorage.userList,
      timestamp: localStorage.timestamp
    };
    return $.post('http://xzysite.appspot.com/bookmark', bundle, function(response) {
      console.log(response);
      if (response.status === 'overwrite') {
        localStorage.userList = response.userlist;
        localStorage.timestamp = response.timestamp;
        userList = JSON.parse(localStorage.userList);
      }
      refreshBadge();
      return bindListener();
    });
  } else {
    refreshBadge();
    return bindListener();
  }
};

$(function() {
  $('body').css('background', "url(" + (chrome.extension.getURL('img/texture.png')) + ") repeat, #FCFAF2");
  return fetch();
});
